
- name: Automation Summary
  id: automation-summary
  shell: bash
  if: always()
  run: |
    start_time=$(date +%s)

    stats=$(jq -s 'reduce .[] as $item ({"passes":0,"failures":0,"pending":0,"skipped":0}; 
      .passes += ($item.stats.passes // 0) |
      .failures += ($item.stats.failures // 0) |
      .pending += ($item.stats.pending // 0) |
      .skipped += ($item.stats.skipped // 0))' cypress/reports/*.json)

    passed=$(echo $stats | jq '.passes')
    failed=$(echo $stats | jq '.failures')
    pending=$(echo $stats | jq '.pending')
    skipped=$(echo $stats | jq '.skipped')
    total=$((passed + failed + pending + skipped))

    end_time=$(date +%s)
    duration=$((end_time - start_time))
    mins=$((duration / 60))
    secs=$((duration % 60))

    status="âœ… All Passed"
    if [ "$failed" -gt 0 ]; then
      status="âŒ Failures Detected"
    elif [ "$pending" -gt 0 ] || [ "$skipped" -gt 0 ]; then
      status="âš ï¸ Partial Execution"
    fi

    echo "# ðŸ§ªâœ¨ Cypress Automation Report âœ¨ðŸ§ª" >> $GITHUB_STEP_SUMMARY
    echo "" >> $GITHUB_STEP_SUMMARY
    echo "### ðŸš¦ Status: $status" >> $GITHUB_STEP_SUMMARY
    echo "" >> $GITHUB_STEP_SUMMARY
    echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
    echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
    echo "| ðŸ§ª **Total Tests** | $total |" >> $GITHUB_STEP_SUMMARY
    echo "| âœ… **Passed Tests** | $passed âœ”ï¸ |" >> $GITHUB_STEP_SUMMARY
    echo "| âŒ **Failed Tests** | $failed âŒ |" >> $GITHUB_STEP_SUMMARY
    echo "| â¸ï¸ **Pending Tests** | $pending âš ï¸ |" >> $GITHUB_STEP_SUMMARY
    echo "| ðŸ”• **Skipped Tests** | $skipped âš ï¸ |" >> $GITHUB_STEP_SUMMARY
    echo "| ðŸ•’ **Duration** | ${mins}m ${secs}s |" >> $GITHUB_STEP_SUMMARY
    echo "" >> $GITHUB_STEP_SUMMARY
    echo "ðŸ“„ **HTML Report:** [View Report](https://orx-aim-ar.s3docs.optum.com/index.html)" >> $GITHUB_STEP_SUMMARY
    echo "ðŸ“¸ **Artifacts:** Cypress screenshots/videos attached" >> $GITHUB_STEP_SUMMARY
    echo "ðŸ”¢ Commit: \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
    echo "ðŸ§‘â€ðŸ’» Author: $(git log -1 --pretty=format:'%an')" >> $GITHUB_STEP_SUMMARY
    echo "ðŸ“† Date: $(git log -1 --date=short --pretty=format:'%cd')" >> $GITHUB_STEP_SUMMARY
